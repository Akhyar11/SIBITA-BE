---
deployment:
  tasks:
    # 1️⃣ Set lokasi deploy
    - export DEPLOYPATH=/home/teknonu1/public_html/sibita.teknonusa.it.com

    # 2️⃣ Pastikan direktori tujuan ada
    - /bin/mkdir -p $DEPLOYPATH

    # 3️⃣ Bersihkan file lama dan copy file baru
    - /bin/rm -rf $DEPLOYPATH/*
    - /bin/cp -R * $DEPLOYPATH/

    # 4️⃣ Aktifkan virtual environment Node.js
    - source /home/teknonu1/nodevenv/public_html/sibita.teknonusa.it.com/22/bin/activate && cd $DEPLOYPATH

    # 5️⃣ Hentikan proses Node.js yang sedang berjalan (jika ada)
    - echo "🛑 Stopping existing Node.js process (if any)..."
    - pkill -f "node dist/main-dev.js" || true

    # 6️⃣ Install dependencies
    - npm install

    # 7️⃣ Build TypeScript
    - npm run build

    # 8️⃣ Jalankan migration jika diperlukan
    - npx sequelize-cli db:migrate || true

    # 9️⃣ Jalankan ulang aplikasi
    - echo "🚀 Starting Node.js app..."
    - nohup node dist/main-dev.js > app.log 2>&1 &
